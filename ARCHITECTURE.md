# 真数据闭环架构设计文档

## 文档信息
- **版本**: v2.0
- **创建日期**: 2025-12-29
- **最后更新**: 2025-12-29
- **作者**: 基于智驾行业7年实战经验
- **适用场景**: L4自动驾驶（物流无人车/载人）、Urban NOA、L3/L4

---

## 一、核心理念

**"指标当第一公民，数据当产品，问题当Bug追"**

真闭环必须满足三层：
1. **感知层闭环**：数据自动发现问题，而非问题驱动数据
2. **诊断层闭环**：系统自动定位问题根源，而非人工跳界面分析
3. **行动层闭环**：问题自动分发、自动验证、自动评估，形成完整闭环

**多模态索引理念**：
- **"不要人工打标签，也不要只存AI的文本总结"**
- 采用"离线大模型自动标注（几何）+ VLM向量化索引（语义）"的双流处理模式

---

## 二、架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        自动驾驶数据闭环系统 v2.0                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  车端层              │  云端层（多模态索引）        │  仿真层        │  组织层      │
│  ┌──────────────┐  │  ┌──────────────────┐  │  ┌──────────┐  │  ┌──────────┐  │
│  │数据采集      │  │  │多模态索引系统    │  │  │场景生成  │  │  │问题分发  │  │
│  │Trigger框架    │  │  │                  │  │  │4D重建    │  │  │团队协作  │  │
│  ├──────────────┤  │  ├──────────────────┤  │  ├──────────┤  │  ├──────────┤  │
│  │体感指标监控  │  │  │ 基础层：自动标注   │  │  │模型训练  │  │  │质量评估  │  │
│  │（一级/二级/三级）│  │  ├──────────────────┤  │  ├──────────┤  │  ├──────────┤  │
│  ├──────────────┤  │  │ 进阶层：向量检索   │  │  │评测验证  │  │  │迭代管理  │  │
│  │三级日志策略  │  │  ├──────────────────┤  │  └──────────┘  │  └──────────┘  │
│  │（micro/mini/  │  │  │ 高级层：场景图     │  │                       │               │
│  │ full）        │  │  ├──────────────────┤  │                       │               │
│  ├──────────────┤  │  │ 终极层：4D重建    │  │                       │               │
│  │沙箱挖数机制  │  │  └──────────────────┘  │                       │               │
│  │（配置下发）    │  │  ┌──────────────────┐  │                       │               │
│  └──────────────┘  │  │ 细粒度标注系统    │  │                       │               │
│                     │  │ └──────────────────┘  │                       │               │
│                     │  ┌──────────────────┐  │                       │               │
│                     │  │ 问题诊断（LLM）   │  │                       │               │
│                     │  └──────────────────┘  │                       │               │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、模块详细设计

### 模块1：车端数据采集层

#### 1.1 体感指标监控（第一公民）

**核心指标体系**：
- **一级指标**（严重体感）：
  - 急刹车（减速度 > 3m/s²）
  - 急转弯（横摆角速度 > 15°/s）
  - 蛇形行驶（横向加速度波动 > 0.5m/s²）
  - 频繁启停（1分钟内 > 3次）
  - 莫名慢行（速度 < 5km/h，非拥堵）

- **二级指标**（轻微体感）：
  - 晚点（偏离计划时间 > 30s）
  - 路径偏离（横向偏移 > 0.5m）
  - 换道犹豫（换道准备时间 > 5s）

- **三级指标**（技术指标）：
  - 感知召回率
  - 预测准确率
  - 规划成功率
  - 控制跟踪误差

#### 1.2 特斯拉机制：四层日志策略

**核心差异**：特斯拉不是写死"一级指标"，而是基于**Shadow Mode（影子模式）**和**Campaigns（任务下发）**的动态探测机制。

| 日志类型 | 触发机制 (Trigger) | 数据内容 (Payload) | 上传策略 (Policy) | 后期自动化用途 |
|---------|-------------------|-------------------|------------------|---------------|
| **Telemetry (微日志)** | 定频 (1Hz) 或 状态变更 | 经纬度、车速、接管信号、错误码、简易特征向量 | 4G 实时 | 生成热力图，发现问题高发区 (ODD Mining) |
| **Snapshot (快照/Mini)** | 影子模式分歧、AEB触发、用户按键反馈、云端Campaign命中 | 关键帧图片(非视频)、目标列表、自车轨迹、周边10s数据 | 4G/5G 优先 | 快速验证模型Bug，以图搜图 |
| **Clip (短视频)** | 复杂场景触发 (如路口博弈失败)、高风险接管 | 前后30s 原始视频流(H.265)、完整Lidar/Radar点云 | Wi-Fi 仅限 (除非事故) | 自动标注 (Auto-labeling)，加入训练集 |
| **Engineering (Full)** | 白名单车辆、重大事故 | 全程无死角数据、中间层特征图 (Feature Maps)、调试日志 | 人工拷贝 / 专线 | 深度复现，Root Cause 分析 |

**关键机制**：

1. **Shadow Mode（影子模式）**：
   - 车端同时运行旧模型和新模型
   - 当两个模型产生分歧时（如旧模型说"直行"，新模型说"左转"），自动触发Snapshot上传
   - 无需人工介入，自动发现模型差异

2. **Campaigns（任务下发）**：
   - 云端工程师写Query："我要收集所有在雨天且车速>60且检测到路边有停止牌的数据"
   - 通过OTA下发给车端
   - 车端作为"过滤器"，只有满足条件时才触发数据上传
   - 避免云端被垃圾数据淹没

3. **缓冲策略**：
   - 普通触发 → Wi-Fi待传队列
   - 碰撞/AEB触发 → 4G优先队列

#### 1.3 Campaign管理机制

**核心设计**：
- **动态任务下发**：云端通过OTA下发Campaign配置
- **智能触发**：车端根据Campaign条件智能触发数据采集
- **任务生命周期**：创建 → 下发 → 执行 → 暂停 → 终止
- **配额管理**：每个Campaign有数据配额，避免过度采集

**Campaign配置示例**：
```json
{
  "campaign_id": "rain_stop_sign_2024",
  "name": "雨天停止牌场景收集",
  "query": {
    "weather": "rain",
    "speed": {"min": 60},
    "objects": [{"type": "stop_sign"}]
  },
  "data_type": "snapshot",
  "quota": 1000,
  "priority": "high",
  "start_time": "2024-01-01T00:00:00Z",
  "end_time": "2024-12-31T23:59:59Z"
}
```

#### 1.4 Shadow Mode（影子模式）

**核心设计**：
- **双模型运行**：线上模型 + 影子模型同时运行
- **分歧检测**：比较两个模型的输出差异
- **自动触发**：分歧超过阈值时自动上传Snapshot
- **无需人工**：全自动发现模型差异

**分歧检测示例**：
```python
# 线上模型输出
online_output = {
    "action": "go_straight",
    "confidence": 0.85,
    "trajectory": [...]
}

# 影子模型输出
shadow_output = {
    "action": "turn_left",
    "confidence": 0.92,
    "trajectory": [...]
}

# 分歧检测
if online_output["action"] != shadow_output["action"]:
    trigger_snapshot_upload(
        reason="model_divergence",
        online_output=online_output,
        shadow_output=shadow_output
    )
```

#### 1.5 沙箱挖数机制

**核心设计**：
- **解耦原则**：挖数Trigger ≠ 线上算法版本
- **配置下发**：云端动态下发挖数配置（JSON格式）
- **沙箱执行**：独立进程，不干扰主算法
- **场景限定**：仅在非自动驾驶任务时段执行

---

### 模块2：云端数据挖掘层

#### 2.1 统一Trigger框架

**框架设计**：
- 车端/云端/仿真三端代码复用
- Python DSL，易于编写和维护
- 自动生成文档（供LLM理解）

#### 2.2 多模态时序事件序列

**数据结构**：
```python
EventSequence = [
  {
    "timestamp": 1234567890.123,
    "event_type": "perception",
    "object_id": "obj_001",
    "attributes": {
      "class": "vehicle",
      "bbox": [x, y, w, h],
      "velocity": [vx, vy],
      "confidence": 0.95
    }
  },
  ...
]
```

#### 2.3 LLM语义对齐

**映射机制**：
- 自定义Token → 文本化映射 → LLM词表空间
- 时序事件序列建模
- 弱监督在线学习

---

### 模块2：云端多模态索引层

#### 2.1 多模态索引设计理念

**行业最佳实践**（特斯拉、Waymo、华为、大疆）：
- **问题**：单纯"打标签"太慢且信息密度低，单纯"AI文本总结"过于笼统且缺乏几何精度
- **方案**：构建多模态、分层级的特征索引系统

#### 2.2 四层索引架构

```
┌─────────────────────────────────────────────────────────────┐
│                    多模态索引系统                            │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────────────┐  │
│  │  终极层：4D重建                                        │  │
│  │  - NeRF / 3D Gaussian Splatting                      │  │
│  │  - 场景编辑、数据增强                                  │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  高级层：场景图                                        │  │
│  │  - 对象关系拓扑结构                                    │  │
│  │  - 交互模式匹配                                        │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  进阶层：向量化检索                                    │  │
│  │  - VLM模型（CLIP/BLIP-2）                             │  │
│  │  - 语义搜索、跨模态检索                                │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  基础层：自动化结构化提取                              │  │
│  │  - 离线大模型自动标注                                  │  │
│  │  - 高精度几何元数据                                    │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

#### 2.3 基础层：自动化结构化提取

**技术方案**：
- **离线教师模型**：大模型推理，生成高精度标注
- **双流处理**：几何流（结构化数据）+ 语义流（自然语言描述）

**核心功能**：
- **关键帧提取**：智能采样，减少冗余
- **对象检测与跟踪**：多类别、长时间跟踪
- **车道线/交通灯识别**：道路要素结构化
- **场景标签生成**：天气、光照、道路类型

**细粒度标注支持**：
- **细粒度物体分类**：16+车辆类型、10+VRU类型、10+障碍物类型
- **关键物体属性**：9种车灯状态、4种车门状态、12种行人姿态
- **静态道路要素**：10种地面标识、12种路面特征
- **场景与环境标签**：13种天气、10种光照、15种道路类型

#### 2.4 进阶层：向量化检索

**技术方案**：
- **VLM模型**：CLIP、BLIP-2、InternVL
- **向量数据库**：FAISS、Milvus
- **相似度计算**：余弦相似度

**检索模式**：
1. **文本检索**：自然语言描述 → 语义向量 → 相似视频
2. **图像检索**：参考图片 → 图像向量 → 相似场景
3. **关键帧检索**：时间戳 → 关键帧向量 → 相似时刻

**混合检索**：
- 向量检索 + 规则过滤
- 语义理解 + 几何精度

#### 2.5 高级层：场景图构建

**技术方案**：
- **图神经网络**：NetworkX、PyTorch Geometric
- **关系类型**：12种交互关系（遮挡、跟随、超车、切入等）

**场景图结构**：
```
节点（Node）：
- 对象节点：车辆、行人、交通灯、车道线
- 属性节点：类型、位置、速度、状态

边（Edge）：
- 空间关系：near、behind、left_of、right_of
- 交互关系：follow、overtake、cut_in、cut_out、crossing
- 语义关系：occluded_by、blocking、yielding
```

**查询能力**：
- 关系模式匹配
- 子图检索
- 时序场景图演化

#### 2.6 终极层：4D重建

**技术方案**：
- **NeRF**：神经辐射场，高质量渲染
- **3D Gaussian Splatting**：实时渲染，可编辑
- **传统SfM**：Structure from Motion

**核心功能**：
- **相机位姿估计**：多视图几何
- **场景对象提取**：可编辑对象实例
- **场景编辑**：添加/删除/修改对象
- **天气修改**：雨天、雪天、雾天
- **数据增强**：视角变化、光照变化

**导出格式**：
- CARLA场景
- LGSVL场景
- 自定义仿真格式

#### 2.7 混合挖掘策略

**策略类型**：
1. **TRIGGER_BASED**：基于Trigger规则挖掘
2. **VECTOR_SEARCH**：基于向量语义检索
3. **RULE_FILTER**：基于规则过滤
4. **EVENT_SEQUENCE**：基于事件序列模式
5. **HYBRID**：混合策略（推荐）

**HYBRID流程**：
```
1. Trigger规则筛选 → 候选集A
2. 向量检索 → 候选集B
3. 规则过滤 → 候选集C
4. 事件序列匹配 → 候选集D
5. 多集合交集 → 最终结果
```

---

### 模块3：细粒度标注系统

#### 3.1 设计目标

支持Urban NOA、L3/L4场景的高精度自动标注，为预测和规划模型提供丰富特征。

#### 3.2 细粒度分类体系

**1. 细粒度物体分类**

| 类别 | 子类型数量 | 示例 |
|------|-----------|------|
| **车辆** | 15+ | 轿车、SUV、警车、救护车、消防车、校车、拖车、搅拌车、起重机 |
| **VRU** | 10+ | 行人、儿童、老人、轮椅、婴儿车、骑行者、摩托车、三轮车、电动滑板车 |
| **障碍物** | 10+ | 交通锥、水马、护栏、减速带、井盖、坑洼、轮胎、箱子 |
| **动物** | 6+ | 狗、猫、牛、马、羊、野生动物 |

**2. 关键物体属性**

| 属性类别 | 属性数量 | 示例 |
|---------|---------|------|
| **车灯状态** | 9种 | 关闭、开启、刹车、左转、右转、双闪、倒车、远光、近光 |
| **车门状态** | 4种 | 关闭、左开、右开、全开 |
| **行人姿态** | 12种 | 站立、行走、奔跑、坐着、躺着、过马路、等待、推车、打伞、分心 |
| **遮挡等级** | 5种 | 无遮挡、轻度、中度、重度、截断 |

**3. 静态道路要素**

| 要素类别 | 类型数量 | 示例 |
|---------|---------|------|
| **地面标识** | 10种 | 车道线、斑马线、停止线、让行线、转向箭头、直行箭头、文字、斜纹斑马线 |
| **红绿灯** | 4种 | 圆形、箭头、倒计时、行人灯 |
| **路面特征** | 12种 | 沥青、混凝土、碎石、泥土、砖块、减速带、井盖、坑洼、积水、结冰、积雪 |

**4. 场景与环境标签**

| 标签类别      | 类型数量 | 示例                                        |
| --------- | ---- | ----------------------------------------- |
| **天气**    | 13种  | 晴天、多云、阴天、小雨、中雨、大雨、小雪、大雪、轻雾、浓雾、薄雾、霾、沙尘暴    |
| **光照**    | 10种  | 白天、夜晚、黄昏、黎明、隧道入口、隧道出口、隧道内、逆光、眩光、阴影        |
| **道路类型**  | 15种  | 高速公路、快速路、城市道路、住宅区、乡村道路、桥梁、隧道、环岛、十字路口、T型路口 |
| **传感器脏污** | 9种   | 干净、泥点、水渍、灰尘、雨滴、蜘蛛网、划痕、指纹、光斑               |

**5. 逻辑与行为标签**

| 标签类别 | 类型数量 | 示例 |
|---------|---------|------|
| **自车关系** | 12种 | CIPV、切入、切出、对向、跟随、超车、被超车、并线、让行、阻挡、交互 |
| **交通流** | 6种 | 自由流、轻度、中度、重度、拥堵、停滞 |
| **违规行为** | 8种 | 逆行、闯红灯、违法横穿、车道违规、超速、违停、禁止掉头 |

**6. 通用占用网络**

**Occupancy Flow**：
- **体素网格**：3D空间离散化
- **占用状态**：空闲、占用、未知
- **运动矢量**：每个体素的运动方向和速度
- **置信度**：占用和运动的置信度

**应用场景**：
- 异形障碍物检测
- 非结构化环境理解
- 预测模型训练

#### 3.3 标注Pipeline

```
视频输入
    ↓
关键帧提取
    ↓
离线教师模型推理
    ↓
细粒度检测
    ├─ 车辆分类（15+类型）
    ├─ VRU分类（10+类型）
    ├─ 障碍物分类（10+类型）
    ├─ 车灯状态检测
    ├─ 车门状态检测
    ├─ 行人姿态识别
    └─ 遮挡等级估计
    ↓
道路要素识别
    ├─ 地面标识检测
    ├─ 红绿灯识别（含倒计时）
    └─ 路面特征分类
    ↓
场景标签生成
    ├─ 天气识别
    ├─ 光照判断
    ├─ 道路类型分类
    └─ 传感器脏污检测
    ↓
行为标签生成
    ├─ 自车关系判断
    ├─ 交通流估计
    └─ 违规行为识别
    ↓
Occupancy Flow生成
    ├─ 体素网格构建
    ├─ 占用状态推断
    └─ 运动矢量估计
    ↓
结构化输出
```

#### 3.4 查询能力

**1. 基础查询**
- 按对象类型查询
- 按场景标签查询
- 按时间范围查询

**2. 细粒度查询**
- 按车辆子类型查询（如救护车、消防车）
- 按行人姿态查询（如过马路、推婴儿车）
- 按车灯状态查询（如左转、刹车）
- 按遮挡等级查询（如重度遮挡）

**3. 组合查询**
- 多条件组合（天气+道路类型+对象类型）
- 时间序列查询（连续帧变化）
- 空间范围查询（特定区域）

**4. 高价值场景查询**
- CIPV车辆切入场景
- 行人过马路+遮挡场景
- 恶劣天气+复杂路况场景
- 违规行为+自车交互场景

---

### 模块4：仿真与训练层

#### 4.1 两类标签体系

| 标签类型 | 用途 | 更新频率 | 维护者 |
|---------|------|---------|--------|
| **挖掘标签** | 数据筛选、场景分类 | 高频（天级） | 算法工程师 |
| **真值标签** | 模型训练、评测验证 | 低频（周级） | 专业标注团队 |

#### 4.2 向量检索精筛流程

```
海量数据 → 嵌入模型 → 向量库
    ↓
查询向量（目标场景）→ Top-K检索 → 相似度排序
    ↓
规则过滤（时间/地点/天气）→ 最终候选集
    ↓
人工抽查 → 真值标注
```

#### 4.3 生成式数据应用策略

**训练侧**：
- 真实数据 + 生成式数据 → 模型训练
- 目的：提升长尾场景召回

**评测侧**：
- 仅使用真实数据 → 模型评测
- 原则：真实世界兜底，不争真值

#### 4.4 差异模式分析

**对比维度**：
- 误检率（False Positive）
- 漏检率（False Negative）
- 置信度分布
- 类别分布

---

### 模块5：数据接收与清洗层

#### 5.1 自动解包流程

**流程**：
```
车端上传 → 云端接收 → 自动解包Rosbag/Record → 提取传感器数据
```

#### 5.2 质量检测（Quality Check）

**自动质量检测**：
- **图像质量**：模糊、过曝、过暗、遮挡、噪声
- **传感器数据**：完整性、一致性、数据范围
- **自动过滤**：质量不达标的数据自动丢弃，不进入标注流程

**质量等级**：
- EXCELLENT（优秀）：所有指标≥80分
- GOOD（良好）：所有指标≥60分
- ACCEPTABLE（可接受）：所有指标≥40分
- POOR（差）：部分指标<40分
- UNUSABLE（不可用）：关键指标<20分

#### 5.3 隐私脱敏（Privacy Masking）

**自动脱敏**：
- **人脸检测**：使用Haar级联分类器
- **车牌检测**：使用边缘检测和轮廓分析
- **人体检测**：使用HOG检测器
- **脱敏方法**：模糊、像素化、黑屏、覆盖

**合规要求**：
- 必须对人脸、车牌进行模糊处理
- 支持视频逐帧脱敏
- 保留原始数据用于内部分析

---

### 模块6：自动评测与训练闭环层

#### 6.1 自动评测（Auto-Evaluation）

**评测流程**：
```
上传的"接管片段" → 作为测试题 → 当前算法版本跑一遍 → 检查是否还会出错
```

**评测类型**：
- **单模型评测**：评测单个模型的性能
- **模型对比**：对比多个模型的性能
- **回归测试**：确保新版本不引入新Bug
- **消融实验**：分析各组件的贡献

**评测指标**：
- 准确率（Accuracy）
- 精确率（Precision）
- 召回率（Recall）
- F1分数（F1 Score）
- IoU
- 平均绝对误差（MAE）
- 均方根误差（RMSE）

#### 6.2 训练闭环（Training Loop）

**训练流程**：
```
自动评测 → 发现问题 → 加入训练集 → 模型训练 → 新模型生成 → OTA推送 → 影子模式验证
```

**训练特性**：
- **早停机制**：验证损失不再改善时自动停止
- **检查点保存**：定期保存模型检查点
- **进度监控**：实时监控训练进度
- **后台训练**：在后台线程中运行训练

#### 6.3 OTA闭环

**OTA流程**：
```
新模型生成 → 灰度发布（10%） → 遥测监控 → 评估效果 → 全量发布或回滚
```

**灰度发布**：
- 初始部署10%车队
- 监控错误率、接管率、用户满意度
- 如果指标恶化，自动回滚
- 如果指标改善，逐步扩大部署比例

**回滚机制**：
- 错误率 > 5% → 自动回滚
- 接管率 > 5% → 自动回滚
- 用户满意度 < 95% → 自动回滚

---

### 模块7：问题分发与协作层

#### 5.1 自动分发机制

**分发策略**：
```
问题诊断 → 团队映射 → 优先级排序 → 任务创建
```

#### 5.2 质量评估体系

**评估维度**：
- 问题发现率
- 问题定位准确率
- 问题解决率
- 问题复发率

---

### 模块8：组织与流程层

#### 6.1 组织结构设计

**打破部门墙**：
- 建立数据闭环委员会
- 感知+规划+控制联合攻关
- 标注团队统一管理
- 仿真团队统一平台

#### 6.2 迭代管理流程

**双周迭代**：
- Week 1：数据收集、问题分析、模型训练
- Week 2：问题修复、灰度发布、复盘改进

---

## 四、全流程自动化Pipeline

### 阶段1：车端智能触发 (Edge Triggering)

**目标**：只传有用的，不传垃圾。

**流程**：
1. **触发器注入**：云端下发Trigger Config（如：检测到前方有异形车辆）
2. **影子对比 (Shadow Mode)**：当驾驶员的操作（如急刹车）与算法的预测（继续加速）产生分歧时，自动标记为"高价值"
3. **数据打包**：Clip Generation - 自动截取触发点 前10s + 后5s 的视频、IMU、CAN、Location
4. **缓冲策略**：
   - 普通触发 → Wi-Fi待传队列
   - 碰撞/AEB触发 → 4G优先队列

### 阶段2：云端接收与清洗 (Ingestion & Cleaning)

**目标**：自动化去噪。

**流程**：
1. **自动解包**：接收Mini log，解压Rosbag/Record文件
2. **质量检测 (Quality Check)**：
   - AI自动扫描视频：是否存在镜头遮挡、严重模糊、过曝/过暗？
   - 如果有问题 → 自动丢弃，不进入标注流程
3. **隐私脱敏**：自动算法对人脸、车牌进行模糊处理（合规必须）

### 阶段3：自动挖掘与索引 (Auto-mining & Indexing)

**目标**：把数据变成可搜索的资产。

**流程**：
1. **Teacher Model刷库**：用超大模型跑一遍数据，生成3D框、车道线等真值（Pseudo-Ground Truth）
2. **Embedding生成**：利用CLIP/VLM生成语义向量
3. **入库**：
   - Metadata（元数据）存入SQL
   - Feature（特征）存入向量库

**结果**：数据已经变成了："某个雨天、路口、有行人的片段"

### 阶段4：模型迭代训练 (Training Loop)

**目标**：用数据解决问题。

**流程**：
1. **自动评测 (Auto-Evaluation)**：将上传的这个"接管片段"作为测试题，让当前的算法版本跑一遍，看是否还会出错
2. **加入训练集**：如果当前模型搞不定，则将该数据（经过人工或自动修正标注后）加入训练集
3. **模型训练**：触发重新训练流程

### 阶段5：OTA闭环

**流程**：
1. 新模型生成后，再次推送到车端的"影子模式"中
2. **验证**：观察针对该场景的Micro log报错率是否下降
3. **灰度发布**：10% → 50% → 100%
4. **自动回滚**：如果指标恶化，自动回滚到上一版本

---

## 五、关键技术点

### 5.1 Trigger代码复用
- 车端/云端/仿真同一套代码
- 配置化部署，无需重新编译
- 版本管理，可追溯

### 5.2 Shadow Mode分歧检测
- 双模型并行运行
- 自动检测模型差异
- 无需人工干预

### 5.3 Campaign任务下发
- 云端动态下发任务
- 车端智能触发
- 避免数据泛滥

### 5.4 多模态索引系统
- **双流处理**：几何流（结构化数据）+ 语义流（自然语言描述）
- **四层架构**：自动标注 → 向量检索 → 场景图 → 4D重建
- **混合策略**：Trigger规则 + 向量检索 + 规则过滤 + 事件序列

### 5.5 细粒度标注
- **50+物体类型**：车辆、VRU、障碍物、动物
- **9种车灯状态**：刹车、转向、双闪等
- **12种行人姿态**：过马路、推车、打伞等
- **13种天气类型**：晴天到沙尘暴
- **Occupancy Flow**：体素网格 + 运动矢量

### 5.6 LLM语义理解
- 时序事件序列建模
- 弱监督在线学习
- 多模态融合

### 5.7 数据成本控制
- 动态启停挖数任务
- 智能降采样
- 存储分级（热/温/冷）

### 5.8 质量保障
- 自动质量检测
- 隐私自动脱敏
- 评测集仅用真实数据
- 差异模式分析

### 5.9 自动化核心口诀
**车端分歧即触发，云端大模型做清洗，向量检索做挖掘，影子模式做验证。**

---

## 六、实施路线图

### 阶段1：基础建设（1-3个月）
- [x] 搭建车端Trigger框架
- [x] 建立体感指标体系
- [x] 实现四层日志策略（Telemetry/Snapshot/Clip/Engineering）
- [x] 搭建基础数据平台

### 阶段2：特斯拉机制实现（3-6个月）
- [x] 实现Campaign管理机制
- [x] 实现Shadow Mode（影子模式）
- [x] 实现分歧检测和自动触发
- [x] 实现数据质量检测
- [x] 实现隐私脱敏

### 阶段3：多模态索引系统（3-6个月）
- [x] 实现基础层：自动化结构化提取
- [x] 实现进阶层：向量化检索
- [x] 实现高级层：场景图构建
- [x] 实现终极层：4D重建
- [x] 实现细粒度标注系统
- [x] 集成混合挖掘策略

### 阶段4：闭环打通（6-9个月）
- [x] 实现云端数据挖掘（集成多模态索引）
- [x] 部署LLM问题诊断
- [x] 建立自动分发机制
- [x] 搭建仿真训练平台

### 阶段5：训练闭环实现（9-12个月）
- [x] 实现自动评测
- [x] 实现训练闭环
- [x] 实现OTA闭环
- [x] 实现灰度发布和自动回滚

### 阶段6：优化迭代（12-18个月）
- [ ] 完善质量评估体系
- [ ] 优化数据成本控制
- [ ] 建立组织协作机制
- [ ] 持续优化Trigger库
- [ ] 优化多模态索引性能

### 阶段7：规模化复制（18个月+）
- [ ] 平台产品化
- [ ] 跨场景复用
- [ ] 生态建设
- [ ] 持续演进

---

## 七、核心原则总结

1. **指标第一公民**：体感指标高于技术指标
2. **数据当产品**：数据质量、成本、效率三管齐下
3. **问题当Bug追**：每个问题都有归属、有追踪、有验证
4. **三端代码复用**：车端、云端、仿真统一Trigger
5. **真值标签隔离**：挖掘标签≠真值标签
6. **生成数据辅助**：训练可用，评测必用真实数据
7. **组织结构适配**：打破部门墙，建立闭环委员会
8. **持续在线学习**：LLM分类弱监督，持续优化
9. **多模态索引**：不要人工打标签，也不要只存AI的文本总结
10. **细粒度标注**：支持Urban NOA/L3/L4场景的高精度自动标注
11. **特斯拉机制**：车端分歧即触发，云端大模型做清洗，向量检索做挖掘，影子模式做验证
12. **全流程自动化**：从车端触发到OTA闭环，全自动运行，无需人工干预